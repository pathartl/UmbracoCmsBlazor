@using System.Text.Json
@using System.Web
@using Umbraco.Cms.Blazor.Services
@inject UmbracoClient Umbraco
@inject ComponentService ComponentService

@if (_componentType != null)
{
    <DynamicComponent Type="_componentType" Parameters="_parameters" />
}


@code {
    [Parameter] public RouteData RouteData { get; set; }

    Type? _componentType = null;
    Type? _modelType = null;
    Dictionary<string, object> _parameters = new();

    protected override async Task OnInitializedAsync()
    {
        var pageContent = await Umbraco.Content.GetByPathAsync(HttpUtility.UrlEncode(RouteData.Template));
        
        _componentType = ComponentService.GetComponentType(pageContent.ContentType);
        _modelType = ComponentService.GetModelType(pageContent.ContentType);
        
        _parameters["ContentType"] = pageContent.ContentType;
        // Need to fix this
        _parameters["Model"] = pageContent.Properties.Deserialize(_modelType);
        _parameters["CreateDate"] = pageContent.CreateDate;
        _parameters["UpdateDate"] = pageContent.UpdateDate;
        _parameters["Id"] = pageContent.Id;
        _parameters["Route"] = pageContent.Route;
        _parameters["Name"] = pageContent.Name;
    }

}